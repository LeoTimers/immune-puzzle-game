<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…ç–«åº”ç­”æµç¨‹å›¾æ‹¼å›¾æ¸¸æˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            overflow-x: auto;
        }

        .container {
            max-width: 1400px;
            min-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.2em;
        }

        .game-area {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 30px;
            margin-bottom: 30px;
        }

        /* æ¨ªå‘æµç¨‹å›¾æ ·å¼ */
        .flowchart-horizontal {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 40px 30px;
            position: relative;
            min-height: 500px;
            border: 3px solid #dee2e6;
            overflow: visible;
        }

        .timeline-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .timeline-axis {
            position: absolute;
            bottom: 50px;
            left: 50px;
            right: 50px;
            height: 4px;
            background: #495057;
            z-index: 1;
        }

        .timeline-label {
            position: absolute;
            bottom: 30px;
            font-weight: bold;
            color: #495057;
            font-size: 1.1em;
        }

        .timeline-left {
            left: 150px;
        }

        .timeline-right {
            right: 150px;
        }

        .first-defense-line {
            position: absolute;
            left: 120px;
            top: 50px;
            bottom: 100px;
            width: 4px;
            background: #ff6b6b;
            z-index: 1;
        }

        .first-defense-label {
            position: absolute;
            left: 130px;
            top: 60px;
            transform: rotate(-90deg);
            transform-origin: left top;
            white-space: nowrap;
            font-weight: bold;
            color: #ff6b6b;
            font-size: 0.9em;
        }

        .immune-divider {
            position: absolute;
            left: 50%;
            top: 50px;
            bottom: 100px;
            width: 2px;
            background: #adb5bd;
            z-index: 1;
        }

        /* å…ç–«åŒºåŸŸå®¹å™¨ */
        .immune-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            height: 100%;
            position: relative;
            z-index: 2;
        }

        .immune-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
        }

        .immune-section.innate {
            border-right: 2px dashed #adb5bd;
        }

        .section-header {
            text-align: center;
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 10px;
            color: #495057;
        }

        /* å…ç–«ç»†èƒç½‘æ ¼å¸ƒå±€ */
        .immune-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .immune-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            align-items: start;
        }

        /* å…ç–«ç»†èƒæ ·å¼ */
        .immune-cell {
            background: white;
            padding: 12px 8px;
            border-radius: 8px;
            border: 2px solid #adb5bd;
            text-align: center;
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .immune-cell.innate {
            border-left: 4px solid #ff6b6b;
        }

        .immune-cell.adaptive {
            border-left: 4px solid #51cf66;
        }

        .immune-cell.blank {
            background: #f8f9fa;
            border: 2px dashed #adb5bd;
            color: #666;
            font-style: italic;
        }

        .immune-cell.blank.hover {
            background: #e9ecef;
            border-color: #4dabf7;
        }

        .immune-cell.correct {
            background: #ebfbee;
            border-color: #51cf66;
        }

        .immune-cell.incorrect {
            background: #fff5f5;
            border-color: #ff6b6b;
        }

        .cell-title {
            font-weight: bold;
            color: #333;
            font-size: 0.85em;
            line-height: 1.2;
        }

        /* ç‰¹æ®ŠèŠ‚ç‚¹æ ·å¼ */
        .pathogen, .clear-pathogen {
            position: absolute;
            background: white;
            padding: 12px 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 3;
            min-width: 100px;
        }

        .pathogen {
            background: #ff8787;
            color: white;
            left: 50px;
            bottom: 150px;
            border: 2px solid #fa5252;
        }

        .clear-pathogen {
            background: #38d9a9;
            color: white;
            right: 50px;
            bottom: 150px;
            border: 2px solid #20c997;
        }

        /* è¿æ¥çº¿æ ·å¼ */
        .connection-line {
            position: absolute;
            background: #495057;
            z-index: 1;
        }

        .arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
            z-index: 2;
        }

        .arrow-right {
            border-width: 6px 0 6px 10px;
            border-color: transparent transparent transparent #495057;
        }

        .arrow-down {
            border-width: 10px 6px 0 6px;
            border-color: #495057 transparent transparent transparent;
        }

        /* æ‹¼å›¾å—åŒºåŸŸ */
        .puzzle-pieces {
            background: #e9ecef;
            border-radius: 15px;
            padding: 20px;
            border: 3px dashed #adb5bd;
            max-height: 500px;
            overflow-y: auto;
        }

        .section-title {
            font-size: 1.3em;
            color: #495057;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .puzzle-piece {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            cursor: grab;
            border: 2px solid #4dabf7;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            text-align: center;
        }

        .puzzle-piece:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .puzzle-piece:active {
            cursor: grabbing;
        }

        .puzzle-piece.used {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #adb5bd;
        }

        .piece-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .piece-type {
            font-size: 0.8em;
            color: #666;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-top: 5px;
        }

        .type-innate {
            background: #ffcccc;
            color: #c92a2a;
        }

        .type-adaptive {
            background: #d3f9d8;
            color: #2b8a3e;
        }

        /* æ§åˆ¶æŒ‰é’®æ ·å¼ */
        .controls {
            text-align: center;
            margin: 30px 0;
        }

        button {
            background: linear-gradient(135deg, #51cf66, #40c057);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(81, 207, 102, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(81, 207, 102, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button.reset {
            background: linear-gradient(135deg, #ff6b6b, #fa5252);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .score {
            text-align: center;
            font-size: 1.2em;
            color: #333;
            margin-top: 20px;
            font-weight: bold;
        }

        .completion-message {
            text-align: center;
            background: linear-gradient(135deg, #51cf66, #40c057);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            display: none;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§© å…ç–«åº”ç­”æµç¨‹å›¾æ‹¼å›¾æ¸¸æˆ</h1>
        <div class="subtitle">å°†å³ä¾§çš„å…ç–«ç»†èƒæ‹–æ‹½åˆ°æµç¨‹å›¾ä¸­æ­£ç¡®çš„ä½ç½®ï¼Œå®Œæˆå…ç–«åº”ç­”è¿‡ç¨‹</div>
        
        <div class="game-area">
            <div class="flowchart-horizontal">
                <div class="section-title">ğŸ”„ å…ç–«åº”ç­”æµç¨‹å›¾</div>
                <div class="timeline-container" id="flowchart-container">
                    <!-- æ—¶é—´è½´ -->
                    <div class="timeline-axis"></div>
                    <div class="timeline-label timeline-left">å›ºæœ‰å…ç–«ï¼ˆæ•°åˆ†é’Ÿè‡³æ•°æ—¥ï¼‰</div>
                    <div class="timeline-label timeline-right">é€‚åº”æ€§å…ç–«ï¼ˆæ•°æ—¥åï¼‰</div>
                    
                    <!-- ç¬¬ä¸€é“é˜²çº¿ç«–çº¿ -->
                    <div class="first-defense-line"></div>
                    <div class="first-defense-label">å…ç–«å±éšœ/è¡¥ä½“ç³»ç»Ÿ</div>
                    
                    <!-- å…ç–«ç±»å‹åˆ†éš”çº¿ -->
                    <div class="immune-divider"></div>
                    
                    <!-- ç‰¹æ®ŠèŠ‚ç‚¹ -->
                    <div class="pathogen">ç—…åŸä½“</div>
                    <div class="clear-pathogen">æ¸…é™¤ç—…åŸä½“</div>
                    
                    <!-- å…ç–«åŒºåŸŸ -->
                    <div class="immune-sections">
                        <!-- å›ºæœ‰å…ç–«åŒºåŸŸ -->
                        <div class="immune-section innate">
                            <div class="immune-grid">
                                <!-- ç¬¬ä¸€è¡Œ -->
                                <div class="immune-row">
                                    <div class="immune-cell innate" data-id="barrier">
                                        <div class="cell-title">å…ç–«å±éšœ</div>
                                    </div>
                                    <div class="immune-cell innate" data-id="dendritic">
                                        <div class="cell-title">æ ‘çªçŠ¶ç»†èƒ</div>
                                    </div>
                                    <div class="immune-cell innate" data-id="neutrophil">
                                        <div class="cell-title">ä¸­æ€§ç²’ç»†èƒ</div>
                                    </div>
                                </div>
                                <!-- ç¬¬äºŒè¡Œ -->
                                <div class="immune-row">
                                    <div class="immune-cell innate" data-id="complement">
                                        <div class="cell-title">è¡¥ä½“ç³»ç»Ÿ</div>
                                    </div>
                                    <div class="immune-cell innate" data-id="nk">
                                        <div class="cell-title">è‡ªç„¶æ€ä¼¤ç»†èƒ</div>
                                    </div>
                                    <div class="immune-cell innate" data-id="macrophage">
                                        <div class="cell-title">å•æ ¸/å·¨å™¬ç»†èƒ</div>
                                    </div>
                                </div>
                                <!-- ç¬¬ä¸‰è¡Œ -->
                                <div class="immune-row">
                                    <div class="immune-cell innate" style="visibility: hidden;"></div>
                                    <div class="immune-cell innate" data-id="ilc">
                                        <div class="cell-title">å›ºæœ‰æ·‹å·´æ ·ç»†èƒ</div>
                                    </div>
                                    <div class="immune-cell innate" data-id="innate-lymphocyte">
                                        <div class="cell-title">å›ºæœ‰æ ·æ·‹å·´ç»†èƒ</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- é€‚åº”æ€§å…ç–«åŒºåŸŸ -->
                        <div class="immune-section adaptive">
                            <div class="immune-grid">
                                <!-- ç¬¬ä¸€è¡Œ -->
                                <div class="immune-row">
                                    <div class="immune-cell adaptive" data-id="t-cell">
                                        <div class="cell-title">Tç»†èƒ</div>
                                    </div>
                                    <div class="immune-cell adaptive" data-id="effector-t">
                                        <div class="cell-title">æ•ˆåº”Tç»†èƒ</div>
                                    </div>
                                    <div class="immune-cell adaptive" data-id="memory-t">
                                        <div class="cell-title">è®°å¿†Tç»†èƒ</div>
                                    </div>
                                </div>
                                <!-- ç¬¬äºŒè¡Œ -->
                                <div class="immune-row">
                                    <div class="immune-cell adaptive" data-id="b-cell">
                                        <div class="cell-title">Bç»†èƒ</div>
                                    </div>
                                    <div class="immune-cell adaptive" data-id="plasma">
                                        <div class="cell-title">æµ†ç»†èƒ</div>
                                    </div>
                                    <div class="immune-cell adaptive" data-id="memory-b">
                                        <div class="cell-title">è®°å¿†Bç»†èƒ</div>
                                    </div>
                                </div>
                                <!-- ç¬¬ä¸‰è¡Œ -->
                                <div class="immune-row">
                                    <div class="immune-cell adaptive" style="visibility: hidden;"></div>
                                    <div class="immune-cell adaptive" data-id="antibody">
                                        <div class="cell-title">æŠ—ä½“</div>
                                    </div>
                                    <div class="immune-cell adaptive" style="visibility: hidden;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="puzzle-pieces">
                <div class="section-title">ğŸ§© æ‹–æ‹½æ‹¼å›¾å—</div>
                <div id="pieces-container">
                    <!-- æ‹¼å›¾å—å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                </div>
            </div>
        </div>

        <div class="completion-message" id="completionMessage">
            <h2>ğŸ‰ æ­å–œï¼ä½ å®Œæˆäº†å…ç–«åº”ç­”æµç¨‹å›¾ï¼</h2>
            <p>ä½ æˆåŠŸç†è§£äº†å›ºæœ‰å…ç–«å’Œé€‚åº”æ€§å…ç–«çš„å®Œæ•´è¿‡ç¨‹ï¼</p>
        </div>

        <div class="controls">
            <button onclick="checkAnswers()">âœ… æ£€æŸ¥ç­”æ¡ˆ</button>
            <button onclick="resetGame()" class="reset">ğŸ”„ é‡æ–°å¼€å§‹</button>
            <button onclick="showHint()">ğŸ’¡ æ˜¾ç¤ºæç¤º</button>
        </div>

        <div class="score" id="score">å¾—åˆ†: 0</div>
    </div>

    <script>
        // å…ç–«ç»†èƒæ•°æ® - æ ¹æ®ä½ æä¾›çš„å›¾ç‰‡
        const immuneCells = [
            // å›ºæœ‰å…ç–«ç»†èƒ
            { id: 'barrier', name: 'å…ç–«å±éšœ', type: 'innate', description: 'çš®è‚¤ã€é»è†œç­‰ç‰©ç†å±éšœ' },
            { id: 'complement', name: 'è¡¥ä½“ç³»ç»Ÿ', type: 'innate', description: 'è¡€æµ†ä¸­çš„è›‹ç™½è´¨ï¼ŒååŠ©æ¸…é™¤ç—…åŸä½“' },
            { id: 'dendritic', name: 'æ ‘çªçŠ¶ç»†èƒ', type: 'innate', description: 'æŠ—åŸå‘ˆé€’ç»†èƒï¼Œè¿æ¥å›ºæœ‰å’Œé€‚åº”æ€§å…ç–«' },
            { id: 'nk', name: 'è‡ªç„¶æ€ä¼¤ç»†èƒ', type: 'innate', description: 'éç‰¹å¼‚æ€§æ€ä¼¤ç—…æ¯’æ„ŸæŸ“ç»†èƒå’Œè‚¿ç˜¤ç»†èƒ' },
            { id: 'ilc', name: 'å›ºæœ‰æ·‹å·´æ ·ç»†èƒ', type: 'innate', description: 'å‚ä¸æ—©æœŸå…ç–«åº”ç­”å’Œç‚ç—‡ååº”' },
            { id: 'neutrophil', name: 'ä¸­æ€§ç²’ç»†èƒ', type: 'innate', description: 'æœ€å…ˆåˆ°è¾¾æ„ŸæŸ“éƒ¨ä½çš„åå™¬ç»†èƒ' },
            { id: 'macrophage', name: 'å•æ ¸/å·¨å™¬ç»†èƒ', type: 'innate', description: 'å¼ºå¤§çš„åå™¬ç»†èƒï¼Œæ¸…é™¤ç—…åŸä½“å’Œç»†èƒç¢ç‰‡' },
            { id: 'innate-lymphocyte', name: 'å›ºæœ‰æ ·æ·‹å·´ç»†èƒ', type: 'innate', description: 'å…·æœ‰æŸäº›é€‚åº”æ€§å…ç–«ç‰¹å¾çš„å›ºæœ‰å…ç–«ç»†èƒ' },
            
            // é€‚åº”æ€§å…ç–«ç»†èƒ
            { id: 't-cell', name: 'Tç»†èƒ', type: 'adaptive', description: 'ç»†èƒå…ç–«çš„ä¸»è¦æ‰§è¡Œè€…' },
            { id: 'b-cell', name: 'Bç»†èƒ', type: 'adaptive', description: 'ä½“æ¶²å…ç–«çš„ä¸»è¦æ‰§è¡Œè€…' },
            { id: 'effector-t', name: 'æ•ˆåº”Tç»†èƒ', type: 'adaptive', description: 'æ‰§è¡Œç»†èƒå…ç–«åŠŸèƒ½çš„Tç»†èƒäºšç¾¤' },
            { id: 'plasma', name: 'æµ†ç»†èƒ', type: 'adaptive', description: 'ç”±Bç»†èƒåˆ†åŒ–è€Œæ¥ï¼Œå¤§é‡äº§ç”ŸæŠ—ä½“' },
            { id: 'memory-t', name: 'è®°å¿†Tç»†èƒ', type: 'adaptive', description: 'æä¾›é•¿æœŸå…ç–«è®°å¿†çš„Tç»†èƒ' },
            { id: 'memory-b', name: 'è®°å¿†Bç»†èƒ', type: 'adaptive', description: 'æä¾›é•¿æœŸå…ç–«è®°å¿†çš„Bç»†èƒ' },
            { id: 'antibody', name: 'æŠ—ä½“', type: 'adaptive', description: 'ç”±æµ†ç»†èƒäº§ç”Ÿçš„å…ç–«çƒè›‹ç™½' }
        ];

        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            score: 0,
            blankCells: [],
            placedPieces: {},
            usedPieces: new Set()
        };

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            createPuzzlePieces();
            createBlankCells();
            // å»¶è¿Ÿåˆ›å»ºè¿æ¥çº¿ï¼Œç¡®ä¿DOMå·²æ¸²æŸ“
            setTimeout(createConnections, 100);
        }

        // åˆ›å»ºè¿æ¥çº¿å’Œç®­å¤´ - ä½¿ç”¨ç½‘æ ¼å¸ƒå±€è®¡ç®—
        function createConnections() {
            const container = document.getElementById('flowchart-container');
            
            // æ¸…é™¤ç°æœ‰çš„è¿æ¥çº¿
            const existingConnections = container.querySelectorAll('.connection-line, .arrow');
            existingConnections.forEach(el => el.remove());
            
            // è·å–å…³é”®å…ƒç´ çš„ä½ç½®
            const pathogen = container.querySelector('.pathogen');
            const barrier = container.querySelector('[data-id="barrier"]');
            const complement = container.querySelector('[data-id="complement"]');
            const dendritic = container.querySelector('[data-id="dendritic"]');
            const tCell = container.querySelector('[data-id="t-cell"]');
            const clearPathogen = container.querySelector('.clear-pathogen');
            
            if (!pathogen || !barrier || !complement || !dendritic || !tCell || !clearPathogen) return;
            
            // è®¡ç®—å…ƒç´ ä¸­å¿ƒç‚¹
            const getCenter = (element) => {
                const rect = element.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();
                return {
                    x: rect.left + rect.width/2 - containerRect.left,
                    y: rect.top + rect.height/2 - containerRect.top
                };
            };
            
            const pathogenCenter = getCenter(pathogen);
            const barrierCenter = getCenter(barrier);
            const complementCenter = getCenter(complement);
            const dendriticCenter = getCenter(dendritic);
            const tCellCenter = getCenter(tCell);
            const clearCenter = getCenter(clearPathogen);
            
            // åˆ›å»ºè¿æ¥çº¿
            // ç—…åŸä½“åˆ°å…ç–«å±éšœå’Œè¡¥ä½“ç³»ç»Ÿ
            createLine(pathogenCenter.x, pathogenCenter.y, barrierCenter.x, barrierCenter.y);
            createLine(pathogenCenter.x, pathogenCenter.y, complementCenter.x, complementCenter.y);
            
            // å…ç–«å±éšœå’Œè¡¥ä½“ç³»ç»Ÿåˆ°æ ‘çªçŠ¶ç»†èƒ
            createLine(barrierCenter.x, barrierCenter.y, dendriticCenter.x, dendriticCenter.y);
            createLine(complementCenter.x, complementCenter.y, dendriticCenter.x, dendriticCenter.y);
            
            // æ ‘çªçŠ¶ç»†èƒåˆ°Tç»†èƒ
            createLine(dendriticCenter.x, dendriticCenter.y, tCellCenter.x, tCellCenter.y);
            
            // ä»æ‰€æœ‰ç»†èƒåˆ°æ¸…é™¤ç—…åŸä½“ï¼ˆç®€åŒ–å¤„ç†ï¼‰
            const allCells = container.querySelectorAll('.immune-cell[data-id]');
            allCells.forEach(cell => {
                const cellCenter = getCenter(cell);
                createLine(cellCenter.x, cellCenter.y, clearCenter.x, clearCenter.y);
            });
        }

        // åˆ›å»ºå•ä¸ªè¿æ¥çº¿
        function createLine(fromX, fromY, toX, toY) {
            const container = document.getElementById('flowchart-container');
            
            // åˆ›å»ºæ°´å¹³è¿æ¥çº¿
            const line = document.createElement('div');
            line.className = 'connection-line';
            line.style.left = fromX + 'px';
            line.style.top = fromY + 'px';
            line.style.width = Math.sqrt(Math.pow(toX - fromX, 2) + Math.pow(toY - fromY, 2)) + 'px';
            line.style.transform = `rotate(${Math.atan2(toY - fromY, toX - fromX)}rad)`;
            line.style.transformOrigin = '0 0';
            line.style.height = '2px';
            container.appendChild(line);
            
            // æ·»åŠ ç®­å¤´
            const arrow = document.createElement('div');
            arrow.className = 'arrow arrow-right';
            arrow.style.left = (toX - 8) + 'px';
            arrow.style.top = (toY - 6) + 'px';
            arrow.style.transform = `rotate(${Math.atan2(toY - fromY, toX - fromX)}rad)`;
            container.appendChild(arrow);
        }

        // åˆ›å»ºæ‹¼å›¾å—
        function createPuzzlePieces() {
            const container = document.getElementById('pieces-container');
            container.innerHTML = '';

            // éšæœºæ‰“ä¹±é¡ºåº
            const shuffledCells = [...immuneCells].sort(() => Math.random() - 0.5);
            
            shuffledCells.forEach(cell => {
                const piece = document.createElement('div');
                piece.className = 'puzzle-piece';
                piece.draggable = true;
                piece.dataset.id = cell.id;
                piece.dataset.cellType = cell.type; // è®°å½•ç»†èƒç±»å‹
                
                piece.innerHTML = `
                    <div class="piece-title">${cell.name}</div>
                    <div class="piece-description">${cell.description}</div>
                    <div class="piece-type ${cell.type === 'innate' ? 'type-innate' : 'type-adaptive'}">
                        ${cell.type === 'innate' ? 'å›ºæœ‰å…ç–«' : 'é€‚åº”æ€§å…ç–«'}
                    </div>
                `;
                
                // æ·»åŠ æ‹–æ‹½äº‹ä»¶
                piece.addEventListener('dragstart', handleDragStart);
                piece.addEventListener('dragend', handleDragEnd);
                
                container.appendChild(piece);
            });
        }

        // åˆ›å»ºç©ºç™½å•å…ƒæ ¼ï¼ˆæŒ–ç©ºçš„ä½ç½®ï¼‰
        function createBlankCells() {
            // é€‰æ‹©ä¸€äº›å•å…ƒæ ¼ä½œä¸ºç©ºç™½ - å›ºå®šé€‰æ‹©å‡ ä¸ªä½ç½®
            const blankPositions = ['dendritic', 'nk', 'macrophage', 't-cell', 'b-cell', 'plasma'];
            
            gameState.blankCells = [];
            
            blankPositions.forEach(position => {
                const cell = document.querySelector(`[data-id="${position}"]`);
                if (cell) {
                    const cellId = cell.dataset.id;
                    const cellName = cell.querySelector('.cell-title')?.textContent || '';
                    const cellType = cell.classList.contains('innate') ? 'innate' : 'adaptive';
                    
                    // ä¿å­˜åŸå§‹å†…å®¹
                    gameState.blankCells.push({
                        element: cell,
                        id: cellId,
                        name: cellName,
                        requiredType: cellType
                    });
                    
                    // è®¾ç½®ä¸ºç©ºç™½çŠ¶æ€
                    cell.innerHTML = '<div class="cell-title">???</div>';
                    cell.classList.add('blank');
                    
                    // æ·»åŠ æ‹–æ”¾äº‹ä»¶
                    cell.addEventListener('dragover', handleDragOver);
                    cell.addEventListener('dragenter', handleDragEnter);
                    cell.addEventListener('dragleave', handleDragLeave);
                    cell.addEventListener('drop', handleDrop);
                }
            });
        }

        // æ‹–æ‹½äº‹ä»¶å¤„ç†
        let draggedPiece = null;

        function handleDragStart(e) {
            if (this.classList.contains('used')) return;
            
            draggedPiece = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.dataset.id);
            
            // ç¡®ä¿æ‹¼å›¾å—åœ¨æ‹–æ‹½æ—¶å¯è§
            this.style.zIndex = '1000';
        }

        function handleDragEnd() {
            this.classList.remove('dragging');
            this.style.zIndex = '';
            draggedPiece = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            return false;
        }

        function handleDragEnter(e) {
            this.classList.add('hover');
        }

        function handleDragLeave() {
            this.classList.remove('hover');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('hover');
            
            if (draggedPiece && !gameState.usedPieces.has(draggedPiece.dataset.id)) {
                const pieceId = draggedPiece.dataset.id;
                const pieceType = draggedPiece.dataset.cellType;
                const pieceName = draggedPiece.querySelector('.piece-title').textContent;
                const targetCell = this;
                const targetCellId = targetCell.dataset.id;
                const targetCellType = targetCell.classList.contains('innate') ? 'innate' : 'adaptive';
                
                // æ£€æŸ¥ç±»å‹æ˜¯å¦åŒ¹é…
                const isTypeMatch = pieceType === targetCellType;
                
                // æ”¾ç½®æ‹¼å›¾å—
                targetCell.innerHTML = `<div class="cell-title">${pieceName}</div>`;
                targetCell.classList.remove('blank');
                
                // è®°å½•æ”¾ç½®ä¿¡æ¯
                gameState.placedPieces[targetCellId] = {
                    pieceId: pieceId,
                    isCorrect: isTypeMatch
                };
                gameState.usedPieces.add(pieceId);
                
                // æ ‡è®°æ‹¼å›¾å—ä¸ºå·²ä½¿ç”¨
                draggedPiece.classList.add('used');
                draggedPiece.draggable = false;
                
                updateScore();
            }
            
            return false;
        }

        // æ›´æ–°å¾—åˆ†
        function updateScore() {
            const placedCount = Object.keys(gameState.placedPieces).length;
            gameState.score = placedCount * 10;
            document.getElementById('score').textContent = `å¾—åˆ†: ${gameState.score}`;
        }

        // æ£€æŸ¥ç­”æ¡ˆ - ä¿®æ”¹ä¸ºæ£€æŸ¥ç±»å‹åŒ¹é…
        function checkAnswers() {
            let correctCount = 0;
            const totalBlanks = gameState.blankCells.length;
            
            gameState.blankCells.forEach(blankCell => {
                const placedPiece = gameState.placedPieces[blankCell.id];
                const cellElement = blankCell.element;
                
                if (placedPiece && placedPiece.isCorrect) {
                    // ç­”æ¡ˆæ­£ç¡®ï¼ˆç±»å‹åŒ¹é…ï¼‰
                    cellElement.classList.add('correct');
                    cellElement.classList.remove('incorrect');
                    correctCount++;
                } else if (placedPiece) {
                    // ç­”æ¡ˆé”™è¯¯ï¼ˆç±»å‹ä¸åŒ¹é…ï¼‰
                    cellElement.classList.add('incorrect');
                    cellElement.classList.remove('correct');
                }
            });
            
            if (correctCount === totalBlanks) {
                showCompletionMessage();
            }
            
            // æ˜¾ç¤ºæ£€æŸ¥ç»“æœ
            alert(`æ­£ç¡®ç­”æ¡ˆ: ${correctCount}/${totalBlanks}\n${correctCount === totalBlanks ? 'ğŸ‰ å®Œç¾ï¼æ‰€æœ‰æ‹¼å›¾éƒ½æ­£ç¡®ï¼' : 'ğŸ’¡ ç»§ç»­åŠªåŠ›ï¼'}`);
        }

        // æ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
        function showCompletionMessage() {
            const message = document.getElementById('completionMessage');
            message.style.display = 'block';
            
            // æ·»åŠ åº†ç¥æ•ˆæœ
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
        }

        // é‡ç½®æ¸¸æˆ
        function resetGame() {
            gameState = {
                score: 0,
                blankCells: [],
                placedPieces: {},
                usedPieces: new Set()
            };
            
            document.getElementById('score').textContent = 'å¾—åˆ†: 0';
            document.getElementById('completionMessage').style.display = 'none';
            
            // é‡æ–°åˆå§‹åŒ–æ‰€æœ‰ç»†èƒ
            const allCells = document.querySelectorAll('.immune-cell[data-id]');
            allCells.forEach(cell => {
                const cellId = cell.dataset.id;
                const originalCell = immuneCells.find(c => c.id === cellId);
                if (originalCell) {
                    cell.innerHTML = `<div class="cell-title">${originalCell.name}</div>`;
                    cell.classList.remove('blank', 'correct', 'incorrect');
                }
            });
            
            // é‡æ–°åˆ›å»ºæ‹¼å›¾å—å’Œç©ºç™½
            createPuzzlePieces();
            createBlankCells();
            
            // é‡æ–°åˆ›å»ºè¿æ¥çº¿
            setTimeout(createConnections, 100);
        }

        // æ˜¾ç¤ºæç¤º
        function showHint() {
            const hint = `
ğŸ’¡ å…ç–«åº”ç­”æµç¨‹æç¤ºï¼š

å›ºæœ‰å…ç–«ï¼ˆå¿«é€Ÿååº”ï¼Œæ•°åˆ†é’Ÿè‡³æ•°æ—¥ï¼‰ï¼š
â€¢ å…ç–«å±éšœ/è¡¥ä½“ç³»ç»Ÿ - ç¬¬ä¸€é“é˜²çº¿
â€¢ æ ‘çªçŠ¶ç»†èƒ - æŠ—åŸå‘ˆé€’ï¼Œè¿æ¥ä¸¤ç§å…ç–«
â€¢ å„ç§å…ç–«ç»†èƒ - éç‰¹å¼‚æ€§æ¸…é™¤ç—…åŸä½“

é€‚åº”æ€§å…ç–«ï¼ˆç‰¹å¼‚æ€§ååº”ï¼Œæ•°æ—¥åï¼‰ï¼š
â€¢ Tç»†èƒå’ŒBç»†èƒ - ç‰¹å¼‚æ€§è¯†åˆ«æŠ—åŸ
â€¢ æ•ˆåº”ç»†èƒå’ŒæŠ—ä½“ - æ‰§è¡Œç‰¹å¼‚æ€§å…ç–«åŠŸèƒ½
â€¢ è®°å¿†ç»†èƒ - æä¾›é•¿æœŸå…ç–«ä¿æŠ¤

è§„åˆ™è¯´æ˜ï¼š
- å›ºæœ‰å…ç–«åŒºåŸŸçš„ç©ºç™½å¯ä»¥æ”¾ç½®ä»»ä½•å›ºæœ‰å…ç–«ç»†èƒ
- é€‚åº”æ€§å…ç–«åŒºåŸŸçš„ç©ºç™½å¿…é¡»æ”¾ç½®å¯¹åº”çš„é€‚åº”æ€§å…ç–«ç»†èƒ
- ç»†èƒä½ç½®å›ºå®šï¼Œæ’åˆ—æ•´é½
            `;
            alert(hint);
        }

        // ç®€å•çš„åº†ç¥æ•ˆæœ
        function confetti(options) {
            const particles = [];
            const particleCount = options.particleCount || 50;
            
            for (let i = 0; i < particleCount; i++) {
                createParticle();
            }
            
            function createParticle() {
                const particle = document.createElement('div');
                particle.innerHTML = ['ğŸ‰', 'ğŸŠ', 'â­', 'âœ¨', 'ğŸ¥³'][Math.floor(Math.random() * 5)];
                particle.style.cssText = `
                    position: fixed;
                    z-index: 10000;
                    font-size: 20px;
                    user-select: none;
                    pointer-events: none;
                    left: ${Math.random() * 100}%;
                    top: ${Math.random() * 100}%;
                `;
                
                document.body.appendChild(particle);
                
                const animation = particle.animate([
                    { 
                        transform: 'translateY(0) rotate(0deg)',
                        opacity: 1
                    },
                    { 
                        transform: `translateY(${window.innerHeight}px) rotate(${Math.random() * 360}deg)`,
                        opacity: 0
                    }
                ], {
                    duration: 2000 + Math.random() * 1000,
                    easing: 'cubic-bezier(0.2, 0, 0.8, 1)'
                });
                
                animation.onfinish = () => particle.remove();
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ¸¸æˆ
        document.addEventListener('DOMContentLoaded', initGame);

        // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°è®¡ç®—è¿æ¥çº¿
        window.addEventListener('resize', () => {
            setTimeout(createConnections, 100);
        });
    </script>
</body>
</html>